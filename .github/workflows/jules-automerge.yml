name: Jules Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  schedule:
    - cron: '0 8 * * *' # Every day at 8 AM
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  automerge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auto-merge Jules PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking for Jules PRs..."
          
          # Find PRs that match Jules criteria (Author, Title, or Branch name)
          # Only look for non-draft PRs since we can't convert drafts with default token
          PRS=$(gh pr list --state open --json number,title,author,headRefName,isDraft --jq '.[] | select((.author.login | contains("jules")) or (.title | contains("Jules")) or (.headRefName | contains("jules"))) | select(.isDraft == false) | .number')
          
          if [ -z "$PRS" ]; then
            echo "No matching Jules PRs found (or all are drafts)."
            exit 0
          fi
          
          for PR in $PRS; do
            echo "Processing PR #$PR..."
            
            # Attempt to merge
            echo "Merging PR #$PR..."
            gh pr merge $PR --merge --delete-branch --auto || gh pr merge $PR --merge --delete-branch || echo "Failed to merge PR #$PR. It might have conflicts or require manual intervention."
          done
